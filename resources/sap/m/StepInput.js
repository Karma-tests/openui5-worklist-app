/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Icon","./Input","./InputBase","./InputRenderer","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/core/LabelEnablement","sap/ui/Device","sap/ui/core/library","sap/ui/core/Renderer","sap/m/library","./StepInputRenderer","sap/ui/events/KeyCodes","sap/base/Log"],function(e,t,i,a,n,r,s,u,o,l,p,h,g,c){"use strict";var f=p.InputType;var d=o.TextAlign;var _=o.ValueState;var y=p.StepInputValidationMode;var V=p.StepInputStepModeType;var m=n.extend("sap.m.StepInput",{metadata:{interfaces:["sap.ui.core.IFormContent"],library:"sap.m",designtime:"sap/m/designtime/StepInput.designtime",properties:{min:{type:"float",group:"Data"},max:{type:"float",group:"Data"},step:{type:"float",group:"Data",defaultValue:1},stepMode:{type:"sap.m.StepInputStepModeType",group:"Data",defaultValue:V.AdditionAndSubtraction},largerStep:{type:"float",group:"Data",defaultValue:2},value:{type:"float",group:"Data",defaultValue:0},name:{type:"string",group:"Misc",defaultValue:null},placeholder:{type:"string",group:"Misc",defaultValue:null},required:{type:"boolean",group:"Misc",defaultValue:false},width:{type:"sap.ui.core.CSSSize",group:"Dimension"},valueState:{type:"sap.ui.core.ValueState",group:"Data",defaultValue:_.None},valueStateText:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Behavior",defaultValue:true},enabled:{type:"boolean",group:"Behavior",defaultValue:true},displayValuePrecision:{type:"int",group:"Data",defaultValue:0},description:{type:"string",group:"Misc",defaultValue:null},fieldWidth:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"50%"},textAlign:{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:d.End},validationMode:{type:"sap.m.StepInputValidationMode",group:"Misc",defaultValue:y.FocusOut}},aggregations:{_input:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"}},events:{change:{parameters:{value:{type:"string"}}}},dnd:{draggable:false,droppable:true}},constructor:function(e,t){n.prototype.constructor.apply(this,arguments);if(this.getEditable()){this._getOrCreateDecrementButton();this._getOrCreateIncrementButton()}if(typeof e!=="string"){t=e}if(t&&t.value===undefined){this.setValue(this._getDefaultValue(undefined,t.max,t.min))}}});var v=sap.ui.getCore().getLibraryResourceBundle("sap.m");m.STEP_INPUT_INCREASE_BTN_TOOLTIP=v.getText("STEP_INPUT_INCREASE_BTN");m.STEP_INPUT_DECREASE_BTN_TOOLTIP=v.getText("STEP_INPUT_DECREASE_BTN");m.INITIAL_WAIT_TIMEOUT=500;m.ACCELLERATION=.8;m.MIN_WAIT_TIMEOUT=50;m.INITIAL_SPEED=120;m._TOLERANCE=10;var b={min:"aria-valuemin",max:"aria-valuemax",value:"aria-valuenow"};var I=["enabled","editable","name","placeholder","required","valueStateText","description","fieldWidth","textAlign"];var T=l.extend(a);T.writeInnerAttributes=function(e,t){e.writeAttribute("type",t.getType().toLowerCase());if(sap.ui.getCore().getConfiguration().getRTL()){e.writeAttribute("dir","ltr")}};T.getAccessibilityState=function(e){var t=a.getAccessibilityState(e),i=e.getParent(),n=i.getMin(),r=i.getMax(),u=i.getValue(),o=i.getAriaLabelledBy(),l=s.getReferencingLabels(i),p=o.concat(l).join(" "),h=i.getAriaDescribedBy().join(" ");t["role"]="spinbutton";t["valuenow"]=u;if(typeof n==="number"){t["valuemin"]=n}if(typeof r==="number"){t["valuemax"]=r}if(h){t["describedby"]=h}if(p){t["labelledby"]=p}return t};var S=t.extend("sap.m.internal.NumericInput",{metadata:{library:"sap.m"},constructor:function(e,i){return t.apply(this,arguments)},renderer:T});S.prototype.onBeforeRendering=function(){i.prototype.onBeforeRendering.call(this);this._deregisterEvents()};m.prototype.init=function(){this._iRealPrecision=0;this._attachChange();this._bPaste=false;this._onmousewheel=this._onmousewheel.bind(this)};m.prototype.onBeforeRendering=function(){var e=this.getMin(),t=this.getMax(),i=this.getValue();this._iRealPrecision=this._getRealValuePrecision();this._getInput().setValue(this._getFormatedValue(i));if(this._isNumericLike(e)&&e>i){this.setValue(e)}if(this._isNumericLike(t)&&t<i){this.setValue(t)}this._disableButtons(i,t,e);this.$().unbind(u.browser.firefox?"DOMMouseScroll":"mousewheel",this._onmousewheel)};m.prototype.onAfterRendering=function(){this.$().bind(u.browser.firefox?"DOMMouseScroll":"mousewheel",this._onmousewheel)};m.prototype.exit=function(){this.$().unbind(u.browser.firefox?"DOMMouseScroll":"mousewheel",this._onmousewheel)};m.prototype.setProperty=function(e,t,i){this._writeAccessibilityState(e,t);n.prototype.setProperty.call(this,e,t,i);if(I.indexOf(e)>-1){this._getInput().setProperty(e,this.getProperty(e),i)}return this};m.prototype.setValidationMode=function(e){if(this.getValidationMode()!==e){switch(e){case sap.m.StepInputValidationMode.FocusOut:this._detachLiveChange();break;case sap.m.StepInputValidationMode.LiveChange:this._attachLiveChange();break}this.setProperty("validationMode",e)}return this};m.prototype.setMin=function(e){var t,i=this.getValue(),a=i!==0&&!i;if(e===undefined){return this.setProperty("min",e,true)}if(!this._validateOptionalNumberProperty("min",e)){return this}t=this.setProperty("min",e,a);this._disableButtons(i,this.getMax(),e);this._verifyValue();return t};m.prototype.setMax=function(e){var t,i=this.getValue(),a=i!==0&&!i;if(e===undefined){return this.setProperty("max",e,true)}if(!this._validateOptionalNumberProperty("max",e)){return this}t=this.setProperty("max",e,a);this._disableButtons(this.getValue(),e,this.getMin());this._verifyValue();return t};m.prototype._validateOptionalNumberProperty=function(e,t){if(this._isNumericLike(t)){return true}c.error("The value of property '"+e+"' must be a number");return false};m.prototype.setDisplayValuePrecision=function(e){var t,i=this.getValue(),a=i!==0&&!i;if(w(e)){t=parseInt(e)}else{t=0;c.warning(this+": ValuePrecision ("+e+") is not correct. It should be a number between 0 and 20! Setting the default ValuePrecision:0.")}return this.setProperty("displayValuePrecision",t,a)};m.prototype.setTooltip=function(e){this._getInput().setTooltip(e)};m.prototype._getIncrementButton=function(){var e=this._getInput().getAggregation("_endIcon");return e?e[0]:null};m.prototype._getDecrementButton=function(){var e=this._getInput().getAggregation("_beginIcon");return e?e[0]:null};m.prototype._createIncrementButton=function(){var e=this;var t=this._getInput().addEndIcon({src:r.getIconURI("add"),id:this.getId()+"-incrementBtn",noTabStop:true,press:this._handleButtonPress.bind(this,true),tooltip:m.STEP_INPUT_INCREASE_BTN_TOOLTIP});t.getEnabled=function(){return this.getEnabled()&&this.getValue()<this.getMax()}.bind(this);t.addEventDelegate({onAfterRendering:function(){t.$().attr("tabindex","-1");e._attachEvents(t,true)}});return t};m.prototype._createDecrementButton=function(){var e=this;var t=this._getInput().addBeginIcon({src:r.getIconURI("less"),id:this.getId()+"-decrementBtn",noTabStop:true,press:this._handleButtonPress.bind(this,false),tooltip:m.STEP_INPUT_DECREASE_BTN_TOOLTIP});t.getEnabled=function(){return this.getEnabled()&&this.getValue()>this.getMin()}.bind(this);t.addEventDelegate({onAfterRendering:function(){t.$().attr("tabindex","-1");e._attachEvents(t,false)}});return t};m.prototype._getInput=function(){if(!this.getAggregation("_input")){var e=new S({id:this.getId()+"-input",textAlign:this.getTextAlign(),type:f.Number,editable:this.getEditable(),enabled:this.getEnabled(),description:this.getDescription(),fieldWidth:this.getFieldWidth(),liveChange:this._inputLiveChangeHandler});this.setAggregation("_input",e)}return this.getAggregation("_input")};m.prototype._handleButtonPress=function(e){var t=this._calculateNewValue(1,e),i=this.getMin(),a=this.getMax();this._btndown=undefined;this._disableButtons(t.displayValue,a,i);this.setValue(t.value);if(this._sOldValue!==this.getValue()){this.fireChange({value:this.getValue()})}this.$().focus();return this};m.prototype._disableButtons=function(e,t,i){if(!this._isNumericLike(e)){return}var a=this._isNumericLike(t),n=this._isNumericLike(i),r=this._getIncrementButton(),s=this._getDecrementButton(),u=this.getEnabled(),o=n&&i>=e,l=a&&t<=e,p=u?o:true,h=u?l:true;s&&s.toggleStyleClass("sapMStepInputIconDisabled",p);r&&r.toggleStyleClass("sapMStepInputIconDisabled",h);return this};m.prototype.onfocusout=function(){this._verifyValue()};m.prototype._verifyValue=function(){var e=this.getMin(),t=this.getMax(),i=parseFloat(this._getInput().getValue());if(!this._isNumericLike(i)){return}if(this._isNumericLike(t)&&i>t||this._isNumericLike(e)&&i<e||this._areFoldChangeRequirementsFulfilled()&&i%this.getStep()!==0){this.setValueState(_.Error)}else{this.setValueState(_.None)}};m.prototype.setValue=function(e){var t;if(e==undefined){e=0}this._sOldValue=this.getValue();if(!this._validateOptionalNumberProperty("value",e)){return this}this._getInput().setValue(this._getFormatedValue(e));this._verifyValue();this._disableButtons(e,this.getMax(),this.getMin());t=this.setProperty("value",parseFloat(e),true);this._iRealPrecision=this._getRealValuePrecision();return t};m.prototype._getFormatedValue=function(e){var t=this.getDisplayValuePrecision(),i,a;if(e==undefined){e=this.getValue()}if(t<=0){return parseFloat(e).toFixed(0)}a=e.toString().split(".");if(a.length===2){i=a[1].length;if(i>t){return parseFloat(e).toFixed(t)}return a[0]+"."+this._padZeroesRight(a[1],t)}else{return e.toString()+"."+this._padZeroesRight("0",t)}};m.prototype._padZeroesRight=function(e,t){var i="",a=e.length;for(var n=a;n<t;n++){i=i+"0"}i=e+i;return i};m.prototype.onsappageup=function(e){this._applyValue(this._calculateNewValue(this.getLargerStep(),true).displayValue);this._verifyValue();e.preventDefault()};m.prototype.onsappagedown=function(e){this._applyValue(this._calculateNewValue(this.getLargerStep(),false).displayValue);this._verifyValue();e.preventDefault()};m.prototype.onsappageupmodifiers=function(e){if(this._isNumericLike(this.getMax())&&!(e.ctrlKey||e.metaKey||e.altKey)&&e.shiftKey){this._applyValue(this.getMax())}};m.prototype.onsappagedownmodifiers=function(e){if(this._isNumericLike(this.getMin())&&!(e.ctrlKey||e.metaKey||e.altKey)&&e.shiftKey){this._applyValue(this.getMin())}};m.prototype.onsapup=function(e){e.preventDefault();this._applyValue(this._calculateNewValue(1,true).displayValue);this._verifyValue()};m.prototype.onsapdown=function(e){e.preventDefault();this._applyValue(this._calculateNewValue(1,false).displayValue);this._verifyValue()};m.prototype._onmousewheel=function(e){var t=this.getDomRef().contains(document.activeElement);if(t){e.preventDefault();var i=e.originalEvent,a=i.detail?-i.detail>0:i.wheelDelta>0;this._applyValue(this._calculateNewValue(1,a).displayValue);this._verifyValue()}};m.prototype.onkeydown=function(e){var t=false;this._bPaste=(e.ctrlKey||e.metaKey)&&e.which===g.V;if(e.which===g.ARROW_UP&&!e.altKey&&e.shiftKey&&(e.ctrlKey||e.metaKey)){this._applyValue(this.getMax());t=true}if(e.which===g.ARROW_DOWN&&!e.altKey&&e.shiftKey&&(e.ctrlKey||e.metaKey)){this._applyValue(this.getMin());t=true}if(e.which===g.ARROW_UP&&!(e.ctrlKey||e.metaKey||e.altKey)&&e.shiftKey){e.preventDefault();this._applyValue(this._calculateNewValue(this.getLargerStep(),true).displayValue);t=true}if(e.which===g.ARROW_DOWN&&!(e.ctrlKey||e.metaKey||e.altKey)&&e.shiftKey){e.preventDefault();this._applyValue(this._calculateNewValue(this.getLargerStep(),false).displayValue);t=true}if(e.which===g.ARROW_UP&&(e.ctrlKey||e.metaKey)){e.preventDefault();this._applyValue(this._calculateNewValue(1,true).displayValue);t=true}if(e.which===g.ARROW_DOWN&&(e.ctrlKey||e.metaKey)){e.preventDefault();this._applyValue(this._calculateNewValue(1,false).displayValue);t=true}if(e.which===g.ARROW_UP&&e.altKey){e.preventDefault();this._applyValue(this._calculateNewValue(1,true).displayValue);t=true}if(e.which===g.ARROW_DOWN&&e.altKey){e.preventDefault();this._applyValue(this._calculateNewValue(1,false).displayValue);t=true}if(t){this._verifyValue()}};m.prototype.onsapescape=function(e){this._getInput().onsapescape(e)};m.prototype._attachLiveChange=function(){this._getInput().attachLiveChange(this._liveChange,this)};m.prototype._detachLiveChange=function(){this._getInput().detachLiveChange(this._liveChange,this)};m.prototype._attachChange=function(){this._getInput().attachChange(this._change,this)};m.prototype._liveChange=function(){this._verifyValue();this._disableButtons(this._getInput().getValue(),this.getMax(),this.getMin())};m.prototype._change=function(e){this._sOldValue=this.getValue();this.setValue(this._getDefaultValue(this._getInput().getValue(),this.getMax(),this.getMin()));if(this._sOldValue!==this.getValue()&&!this._isButtonFocused()){this.fireChange({value:this.getValue()})}};m.prototype._applyValue=function(e){if(!this.getEditable()||!this.getEnabled()){return}this.getAggregation("_input")._$input.val(this._getFormatedValue(e))};m.prototype._calculateNewValue=function(e,t){var i=this.getStep(),a=this.getMax(),n=this.getMin(),r=this.getValue(),s=parseFloat(this._getDefaultValue(this._getInput().getValue(),a,n)),u=t?1:-1,o=Math.abs(i)*Math.abs(e),l=s+u*o,p,h,g=this.getDisplayValuePrecision();if(g>0){p=this._sumValues(s,o,u,g)}else{p=l}if(this._areFoldChangeRequirementsFulfilled()){l=p=h=this._calculateClosestFoldValue(s,o,u)}else{h=this._sumValues(r,o,u,this._iRealPrecision)}if(this._isNumericLike(a)&&l>=a){h=a;p=a}if(this._isNumericLike(n)&&l<=n){h=n;p=n}return{value:h,displayValue:p}};m.prototype._getRealValuePrecision=function(){var e=this.getValue().toString().split("."),t=this.getStep().toString().split("."),i,a;i=!e[1]?0:e[1].length;a=!t[1]?0:t[1].length;return i>a?i:a};m.prototype.setValueState=function(e){var t=false,i=false;switch(e){case _.Error:t=true;break;case _.Warning:i=true;break;case _.Success:case _.None:break;default:return this}this._getInput().setValueState(e);setTimeout(function(){this.$().toggleClass("sapMStepInputError",t).toggleClass("sapMStepInputWarning",i)}.bind(this),0);this.setProperty("valueState",e,true);return this};m.prototype.setEditable=function(e){var t=m.prototype.setProperty.call(this,"editable",e);this._getOrCreateDecrementButton().setVisible(e);this._getOrCreateIncrementButton().setVisible(e);return t};m.prototype._getOrCreateDecrementButton=function(){return this._getDecrementButton()||this._createDecrementButton()};m.prototype._getOrCreateIncrementButton=function(){return this._getIncrementButton()||this._createIncrementButton()};m.prototype._inputLiveChangeHandler=function(e){var t=this.getParent()._restrictCharsWhenDecimal(e);this.setProperty("value",t?t:e.getParameter("newValue"),true)};m.prototype._restrictCharsWhenDecimal=function(e){var t=e.getParameter("value").indexOf("."),i=this.getDisplayValuePrecision(),a;if(t>0&&i>0){var n=e.getParameter("value"),r=n.split(".")[1],s=r?r.length:0,u=e.getSource().getProperty("value"),o=n.split(".")[0],l=u.substring(u.indexOf(".")+1,u.length);if(!this._bPaste){if(s>i){a=o+"."+l;this._showWrongValueVisualEffect()}}else{if(n.indexOf(".")){a=n.split(".")[0]+"."+r.substring(0,i)}this._bPaste=false}}this._getInput().updateDomValue(a);return a};m.prototype._showWrongValueVisualEffect=function(){var e=this.getValueState();if(e===_.Error){return}this.setValueState(_.Error);setTimeout(this["setValueState"].bind(this,e),1e3)};m.prototype._getDefaultValue=function(e,t,i){if(e!==""&&e!==undefined){return this._getInput().getValue()}if(this._isNumericLike(i)&&i>0){return i}else if(this._isNumericLike(t)&&t<0){return t}else{return 0}};m.prototype._isNumericLike=function(e){return!isNaN(e)&&e!==null&&e!==""};m.prototype._isInteger=function(e){return e===parseInt(e)};m.prototype._writeAccessibilityState=function(e,t){var i=this._getInput().getDomRef("inner");if(!i){return}if(e&&b[e]){i.setAttribute(b[e],t)}};m.prototype._isButtonFocused=function(){return document.activeElement===this._getIncrementButton().getDomRef()||document.activeElement===this._getDecrementButton().getDomRef()};m.prototype._sumValues=function(e,t,i,a){var n=Math.pow(10,a),r=parseInt((e*n).toFixed(10)),s=parseInt((t*n).toFixed(10));return(r+i*s)/n};m.prototype._areFoldChangeRequirementsFulfilled=function(){return this.getStepMode()===V.Multiple&&this.getDisplayValuePrecision()===0&&this._isInteger(this.getStep())&&this._isInteger(this.getLargerStep())};m.prototype._calculateClosestFoldValue=function(e,t,i){var a=Math.floor(e),n=t;do{a+=i;n--}while(a%t!==0&&n);if(a%t!==0){c.error("Wrong next/previous value "+a+" for "+e+", step: "+t+" and sign: "+i,this)}return a};function w(e){return typeof e==="number"&&!isNaN(e)&&e>=0&&e<=20}m.prototype._calcWaitTimeout=function(){this._speed*=m.ACCELLERATION;this._waitTimeout=this._waitTimeout-this._speed<m.MIN_WAIT_TIMEOUT?m.MIN_WAIT_TIMEOUT:this._waitTimeout-this._speed;return this._waitTimeout};m.prototype._spinValues=function(e){var t=this;if(this._btndown){this._spinTimeoutId=setTimeout(function(){if(t._btndown){var i=t._calculateNewValue(1,e);t.setValue(i.value);if(!t._getIncrementButton().getEnabled()||!t._getDecrementButton().getEnabled()){N.call(t);t.fireChange({value:t.getValue()})}t._spinValues(e)}},t._calcWaitTimeout())}};m.prototype._attachEvents=function(e,t){var i=this;var a={onmousedown:function(e){if(e.button===0&&!i._btndown){i._waitTimeout=m.INITIAL_WAIT_TIMEOUT;i._speed=m.INITIAL_SPEED;i._btndown=true;i._spinValues(t)}},onmouseup:function(e){if(i._btndown){N.call(i)}},onmouseout:function(e){if(i._btndown){N.call(i);i.fireChange({value:i.getValue()})}},oncontextmenu:function(e){e.stopImmediatePropagation(true);e.preventDefault();e.stopPropagation()}};e.addDelegate(a,true)};m.prototype.getIdForLabel=function(){return this.getAggregation("_input").getIdForLabel()};function N(){if(this._btndown){this._btndown=undefined;clearTimeout(this._spinTimeoutId);this._waitTimeout=500;this._speed=120}}return m});